# CI / CD

CI の実施はアプリケーションの品質を保つために必要不可欠です。また CD は、開発者の負担を軽減し、リリース時の事故リスクを軽減します。

CI は開発当初に設定し、CD は開発が進んでアーキテクチャ構成が整ってきた段階で設定します。

ロンランでは CI / CD 基盤には原則 GitHub のみを利用します。

> [!NOTE]
> クラウドインフラに用意されたするビルド＆デプロイパイプライン（Google Cloud Build, AWS CodeBuild, AWS Code Pipeline など）は、原則利用しません。クラウド側で設定するよりも GitHub Actions に集約した方がフローと設定の見通しがよいことと、クラウド側のビルドサービスはマルチステージにネイティブ対応しておらず、対応させるための苦労が多いためです

# CI

- CI の対象は**静的テスト、ユニットテスト、結合テスト、E2E テスト**です
  - パフォーマンステストやセキュリティテストは CI に組み込む必要はありません
- 静的テストとユニットテストは Pull Request イベントをトリガーに実行します
- 結合テストと E2E テストは原則 main ブランチへのマージイベントをトリガーに実行します（一般的に、時間が掛かるため）

# CD

- CD は「リリース作成」「ビルド」「デプロイ」の三つの工程とします
- リリース作成には GitHub Release を利用します
- ビルドとデプロイは GitHub Actions を利用します
- デプロイについて、Continuas Delivery と Continuas Deployment を区別し、以下のように用意します
  - 必須：Continuas Delivery: ビルド後のデプロイを手動で行う
  - オプション：Continuas Deployment: ビルド後のデプロイが自動で行われる

> [!NOTE]
> ロンランではトランクベース開発を採用しています。このため、リリースブランチを作成することはありません。リリースは main ブランチから作成します。

## 1. リリースの作成

開発者が作業します。

- レポジトリまたはパッケージのバージョンを bump します
- GitHub Release にてリリースノートを記載し、新しいバージョンと同一名の tag を付与します

## 2. ビルド

開発者が作業します。

- ビルド用 GitHub Actions woklflow_dispatch でビルドを行います。この際、対象にはリリース作成時の tag を指定します
- woklflow_dispatch には次の選択 UI を用意しておきます
  - ビルド対象ステージの選択。ステージに応じたビルド環境変数が選択される
  - 自動デプロイ。Continuas Deployment を行う場合は、自動デプロイのオプションを有効にする
- ビルドアーティファクトは GitHub 上にアップロードされるようにしておきます

## 3. デプロイ（Continuas Delivery の場合）

開発者に権限のあるステージは開発者自身が行い、商用環境については運用管理者が行います。

- デプロイ用 GitHub Actions woklflow_dispatch, cli, deploy script のいずれかでデプロイを行います
- いずれの方法であっても、ビルド工程で作成済みのビルドアーティファクトを指定して実施します

以上
